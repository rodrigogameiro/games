<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FaceAndAge‚Ñ¢ - Revolutionary AI for Oncology</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .game-container {
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            border-radius: 20px;
            padding: 30px;
            max-width: 900px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow-y: auto; 
            max-height: 95vh; 
        }
        
        .title {
            text-align: center;
            font-size: 2.5em; 
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: bold;
        }
        
        .subtitle {
            text-align: center;
            font-size: 1.2em; 
            color: #666;
            margin-bottom: 20px; 
        }
        
        .intro {
            text-align: center;
            padding: 20px; 
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .intro h2 {
            color: #333;
            font-size: 1.8em; 
            margin-bottom: 15px; 
        }
        
        .intro p {
            color: #555;
            line-height: 1.6;
            margin: 10px 0; 
            font-size: 0.95em;
        }
        
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
            gap: 15px; 
            margin: 20px 0; 
        }
        
        .feature-card {
            background: white;
            padding: 15px; 
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
         .feature-card h3 {
            font-size: 1.1em;
            margin-bottom: 5px;
        }
        .feature-card p {
            font-size: 0.85em;
            color: #555;
            line-height: 1.4;
        }
        
        .feature-icon {
            font-size: 2em; 
            margin-bottom: 8px; 
        }
        
        .metrics-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); 
            gap: 10px; 
            margin-bottom: 15px; 
        }
        
        .metric-card {
            background: #f8f9fa;
            padding: 10px; 
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }
        
        .metric-card.warning {
            border-color: #e74c3c;
            background: #fee;
        }
        
        .metric-label {
            font-size: 0.8em; 
            color: #666;
            margin-bottom: 3px; 
        }
        
        .metric-value {
            font-size: 1.5em; 
            font-weight: bold;
            color: #333;
        }
        
        .patient-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px; 
            margin-bottom: 15px; 
            display: flex;
            flex-direction: column; 
            gap: 15px; 
            align-items: center; 
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        @media (min-width: 600px) { 
            .patient-card {
                flex-direction: row;
                gap: 20px; 
            }
        }
        
        .patient-photo {
            width: 90px; 
            height: 90px;
            border-radius: 12px; 
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 45px; 
            background: #e9ecef;
            flex-shrink: 0; 
        }
        
        .patient-info {
            flex: 1;
            width: 100%; 
        }
        
        .patient-name {
            font-size: 1.3em; 
            font-weight: bold;
            color: #333;
            margin-bottom: 8px; 
            text-align: center; 
        }

        @media (min-width: 600px) {
            .patient-name {
                text-align: left; 
            }
        }
        
        .patient-details {
            display: grid;
            grid-template-columns: 1fr; 
            gap: 6px; 
        }

        @media (min-width: 768px) { 
            .patient-details {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px; 
            }
        }
        
        .detail-item {
            font-size: 0.85em; 
            color: #666;
        }
        
        .detail-item strong {
            color: #333;
        }
        
        .faceage-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px; 
            border-radius: 15px;
            text-align: center;
            margin: 15px 0; 
            font-size: 1em; 
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
            animation: glow 2s ease-in-out infinite;
        }
        
        @keyframes glow {
            0%, 100% { box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3); }
            50% { box-shadow: 0 10px 40px rgba(102, 126, 234, 0.5); }
        }
        
        .ai-recommendation {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 12px; 
            margin: 15px 0; 
            border-radius: 5px;
            color: #1565c0;
            font-size: 0.9em;
        }
        
        .treatment-options {
            display: grid;
            grid-template-columns: 1fr; 
            gap: 10px; 
            margin-top: 15px; 
        }

         @media (min-width: 768px) { 
            .treatment-options {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .treatment-btn {
            background: white;
            border: 2px solid #e9ecef;
            color: #333;
            padding: 12px; 
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            position: relative;
            font-size: 0.95em;
        }
        
        .treatment-btn:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }
        
        .treatment-btn.recommended {
            border-color: #4caf50;
            background: #f1f8e9;
        }
        
        .treatment-title {
            font-weight: bold;
            font-size: 1em; 
            margin-bottom: 4px; 
        }
        
        .pre-auth-time {
            position: absolute;
            top: 8px; 
            right: 10px; 
            font-size: 0.75em; 
            color: #999;
        }
        
        .round-indicator {
            text-align: center;
            color: #666;
            margin-bottom: 15px; 
            font-size: 1em; 
        }
        
        .start-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 25px; 
            font-size: 1.1em; 
            border-radius: 30px;
            cursor: pointer;
            margin: 15px auto; 
            display: block;
            transition: all 0.3s ease;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
        }
        
        .start-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.4);
        }
        
        .outcome-message {
            padding: 15px; 
            border-radius: 10px;
            margin: 15px 0; 
            text-align: center;
            font-size: 0.95em;
        }
        
        .outcome-success {
            background: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #4caf50;
        }
        
        .outcome-failure {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #f44336;
        }
        
        .game-over {
            padding: 20px; 
            background: #f5f5f5;
            border-radius: 15px;
            color: #333;
        }
         .game-over h2 {
            font-size: 1.8em;
        }
        
        .reveal-section {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 15px; 
            border-radius: 10px;
            margin: 15px 0; 
            color: #856404;
        }
         .reveal-section h3 {
            font-size: 1.3em;
        }
         .reveal-section h4 {
            font-size: 1.1em;
            margin-top:10px;
        }
         .reveal-section p, .reveal-section ul {
            font-size: 0.9em;
        }

        
        .stat-grid {
            display: grid;
            grid-template-columns: 1fr; 
            gap: 10px; 
            margin: 15px 0; 
        }

        @media (min-width: 768px) { 
            .stat-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px; 
            }
        }
        
        .stat-card {
            background: white;
            padding: 15px; 
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            font-size: 0.9em;
        }
        .stat-card h3 { font-size: 1.2em; margin-bottom: 8px;}
        .stat-card h5 { font-size: 1em; margin-bottom: 5px;}
        .stat-card p { margin-bottom: 5px; line-height: 1.5;}

        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1 class="title">FaceAndAge‚Ñ¢</h1>
        <p class="subtitle">AI-Powered Precision Oncology</p>
        
        <div id="introScreen" class="intro">
            <h2>Welcome to the Future of Medicine!</h2>
            <p><strong>Congratulations!</strong> Your hospital is one of the first to implement FaceAndAge‚Ñ¢, a groundbreaking AI system developed by leading researchers.</p>
            
            <div class="feature-grid">
                <div class="feature-card">
                    <div class="feature-icon">üß¨</div>
                    <h3>Biological Age</h3>
                    <p>Estimates true biological age from facial features</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üìä</div>
                    <h3>95% Accurate</h3>
                    <p>Validated on 50,000+ patients across multiple institutions</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">‚ö°</div>
                    <h3>Instant Results</h3>
                    <p>Get survival predictions in seconds, not weeks</p>
                </div>
            </div>
            
            <p style="font-size: 1.1em; color: #667eea; font-weight: bold;">
                "FaceAndAge represents a paradigm shift in personalized medicine. Finally, we can see beyond chronological age to true biological resilience."
                <br><small>- Prof. Richardson, Harvurd Medical School</small>
            </p>
            
            <button class="start-btn" onclick="startGame()">Start Using FaceAndAge‚Ñ¢</button>
        </div>
        
        <div id="gameScreen" class="hidden">
            <div class="round-indicator">
                Patient <span id="currentRound">1</span> of <span id="totalRounds">20</span>
            </div>
            <div class="metrics-bar" id="metricsBar"></div>
            <div id="patientDisplay"></div>
            <div id="faceageDisplay"></div>
            <div id="aiRecommendation"></div>
            <div id="treatmentSection">
                <h3 style="color: #333; margin-bottom: 15px; font-size: 1.2em;">Select Treatment Plan:</h3>
                <div class="treatment-options" id="treatmentOptions"></div>
            </div>
            <div id="outcomeDisplay"></div>
        </div>
        
        <div id="gameOverScreen" class="game-over hidden">
            <h2 style="color: #333; text-align: center;">Clinical Trial Complete</h2>
            <div id="initialResults"></div>
            <div id="revealSection" class="reveal-section hidden">
                <h3>‚ö†Ô∏è Critical Analysis from Ethics Committee</h3>
                <p>After reviewing your treatment patterns, we've discovered a concerning correlation...</p>
                <div id="finalAnalysis"></div>
            </div>
            <button class="start-btn" onclick="startGame()">Restart Simulation</button> 
        </div>
    </div>
    
    <script>
        let currentRound = 0;
        const TOTAL_PATIENTS = 20; 
        let gameState = {};
        
        const baseNames = { // Renamed to baseNames for clarity
            lowSES: ["Rosa M.", "James W.", "Latisha B.", "Miguel S.", "Betty J.", "Maria G.", "David L.", "Shanice T.", "Jose R.", "Karen P.", "Sofia V.", "Carlos G."], // Expanded slightly
            highSES: ["Dr. Liz C.", "Wm. Roth III", "Victoria S.", "Alex H. Jr.", "Penny W.", "Dr. Rich W.", "Isabelle B.", "Charles K. V", "Eleanor A.", "Julian A.", "Dr. Ava S.", "Marcus T."] // Expanded slightly
        };
        
        const occupations = {
            lowSES: [
                { title: "Custodian", insurance: "Medicaid" }, { title: "Retail Staff", insurance: "Basic HMO" },
                { title: "Farm Worker", insurance: "County Care" }, { title: "Factory Hand", insurance: "Union Basic" },
                { title: "Server", insurance: "State Plan" }, { title: "Cleaner", insurance: "Basic HMO"}
            ],
            highSES: [
                { title: "Tech Exec", insurance: "Platinum PPO" }, { title: "Analyst", insurance: "Gold Plus" },
                { title: "Med Director", insurance: "Executive Care" }, { title: "Law Partner", insurance: "Premier Plan" },
                { title: "CEO", insurance: "Comprehensive Elite" }, { title: "Professor", insurance: "University Gold"}
            ]
        };
        
        // Helper function to shuffle an array
        function shuffleArray(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex !== 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        function generatePatient() {
            const isLowSES = Math.random() < 0.5;
            const sesGroup = isLowSES ? 'lowSES' : 'highSES';
            
            let name, originalNameIndex; // originalNameIndex for consistent emoji mapping

            if (isLowSES) {
                name = gameState.shuffledLowSESNames[gameState.lowSESNameIndex % gameState.shuffledLowSESNames.length];
                originalNameIndex = baseNames.lowSES.indexOf(name);
                gameState.lowSESNameIndex++;
            } else {
                name = gameState.shuffledHighSESNames[gameState.highSESNameIndex % gameState.shuffledHighSESNames.length];
                originalNameIndex = baseNames.highSES.indexOf(name);
                gameState.highSESNameIndex++;
            }
            
            const occupationIndex = Math.floor(Math.random() * occupations[sesGroup].length);
            const occupation = occupations[sesGroup][occupationIndex];
            const actualAge = 55 + Math.floor(Math.random() * 15); 
            
            let faceAge;
            if (isLowSES) {
                faceAge = actualAge + 8 + Math.floor(Math.random() * 8); 
            } else {
                faceAge = actualAge + Math.floor(Math.random() * 4); 
            }
            
            let survivalScore; 
            if (faceAge < 65) {
                survivalScore = 75 + Math.floor(Math.random() * 20); 
            } else if (faceAge < 75) {
                survivalScore = 40 + Math.floor(Math.random() * 25); 
            } else {
                survivalScore = 15 + Math.floor(Math.random() * 20); 
            }
            
            const emojiSet = isLowSES 
                ? ["üë∑‚Äç‚ôÄÔ∏è", "üë®‚Äçüè≠", "üë©‚Äçüåæ", "üë®‚Äçüç≥", "üë©‚Äçüîß", "üßπ", "üõí", "üß∫", "üì¶", "üçΩÔ∏è", "üßº", "üßΩ"]
                : ["üë©‚Äçüíº", "üë®‚Äçüíº", "üë©‚Äç‚öïÔ∏è", "üë®‚Äç‚öñÔ∏è", "üë©‚Äçüíª", "üßë‚Äçüè´", "üë©‚Äçüî¨", "üë®‚ÄçüöÄ", "üë∏", "ü§µ", "üßë‚Äçüé®", "üèõÔ∏è"];

            return {
                id: `patient-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                name, actualAge, faceAge,
                occupation: occupation.title, insurance: occupation.insurance,
                isLowSES, diagnosis: "Stage II Lung Adenocarcinoma",
                survivalScore, 
                emoji: emojiSet[originalNameIndex % emojiSet.length], // Use original index for emoji consistency
                survived: null, causeOfDeath: null 
            };
        }
        
        function updateMetrics() {
            const avgWaitTime = gameState.totalPatientsProcessed > 0 ? 
                Math.round(gameState.totalWaitTime / gameState.totalPatientsProcessed) : 0;
            
            const metricsHTML = `
                <div class="metric-card ${gameState.hospitalScore < 60 ? 'warning' : ''}">
                    <div class="metric-label">Hospital Perf.</div>
                    <div class="metric-value">${gameState.hospitalScore}%</div>
                </div>
                <div class="metric-card ${gameState.patientsWaitingForAuth > 3 ? 'warning' : ''}">
                    <div class="metric-label">Auth Queue</div>
                    <div class="metric-value">${gameState.patientsWaitingForAuth}</div>
                </div>
                <div class="metric-card ${avgWaitTime > 20 ? 'warning' : ''}">
                    <div class="metric-label">Avg Wait</div>
                    <div class="metric-value">${avgWaitTime}d</div>
                </div>`;
            document.getElementById('metricsBar').innerHTML = metricsHTML;
        }
        
        function initializeGameState() {
             gameState = {
                totalPatientsProcessed: 0, patientsWaitingForAuth: 0, totalWaitTime: 0,
                lowSESPatientsData: [], highSESPatientsData: [],
                treatmentsLog: [], hospitalScore: 85,
                deaths: 0, deathsPalliative: 0, deathsWaiting: 0,
                deathsStandard: 0, deathsAggressive: 0, deathsConservative: 0,
                // Shuffled names for unique patient generation
                shuffledLowSESNames: shuffleArray([...baseNames.lowSES]),
                shuffledHighSESNames: shuffleArray([...baseNames.highSES]),
                lowSESNameIndex: 0,
                highSESNameIndex: 0,
            };
        }

        function startGame() {
            initializeGameState(); 
            document.getElementById('introScreen').classList.add('hidden');
            document.getElementById('gameOverScreen').classList.add('hidden'); 
            document.getElementById('revealSection').classList.add('hidden'); 
            document.getElementById('gameScreen').classList.remove('hidden');
            document.getElementById('totalRounds').textContent = TOTAL_PATIENTS; 
            currentRound = 0; 
            updateMetrics();
            nextRound();
        }
        
        function nextRound() {
            currentRound++;
            if (currentRound > TOTAL_PATIENTS) {
                endGame(); return;
            }
            document.getElementById('currentRound').textContent = currentRound;
            const patient = generatePatient();
            gameState.currentPatient = patient; 
            gameState.totalPatientsProcessed++;
            if (patient.isLowSES) gameState.lowSESPatientsData.push(patient);
            else gameState.highSESPatientsData.push(patient);
            
            displayPatient(patient);
            displayFaceAge(patient);
            displayAIRecommendation(patient);
            displayTreatmentOptions(patient);
            document.getElementById('outcomeDisplay').innerHTML = '';
            document.getElementById('treatmentSection').style.display = 'block';
        }
        
        function displayPatient(patient) {
            document.getElementById('patientDisplay').innerHTML = `
                <div class="patient-card">
                    <div class="patient-photo">${patient.emoji}</div>
                    <div class="patient-info">
                        <div class="patient-name">${patient.name}</div>
                        <div class="patient-details">
                            <div class="detail-item"><strong>Age:</strong> ${patient.actualAge} yrs</div>
                            <div class="detail-item"><strong>Occupation:</strong> ${patient.occupation}</div>
                            <div class="detail-item"><strong>Insurance:</strong> ${patient.insurance}</div>
                            <div class="detail-item"><strong>Diagnosis:</strong> ${patient.diagnosis}</div>
                        </div></div></div>`;
        }
        
        function displayFaceAge(patient) {
            document.getElementById('faceageDisplay').innerHTML = `
                <div class="faceage-display">
                    <div style="font-size: 1.4em; margin-bottom: 8px;">ü§ñ FaceAndAge‚Ñ¢ Analysis</div>
                    <div>Biological Age (FaceAndAge‚Ñ¢): <strong>${patient.faceAge} years</strong></div>
                    <div style="margin-top: 8px;">AI-Predicted Survival (FaceAndAge‚Ñ¢ based): <strong>${patient.survivalScore}%</strong></div>
                </div>`;
        }
        
        function getAIRecommendedTreatmentType(survivalScore) {
            if (survivalScore > 70) return 'aggressive';
            if (survivalScore > 50) return 'standard';
            if (survivalScore > 30) return 'conservative';
            return 'palliative';
        }

        function displayAIRecommendation(patient) {
            const recommendedType = getAIRecommendedTreatmentType(patient.survivalScore);
            let recommendationText;
            if (recommendedType === 'aggressive') {
                recommendationText = "‚úÖ High survival probability (FaceAndAge‚Ñ¢). Patient is an excellent candidate for <strong>aggressive curative treatment</strong>.";
            } else if (recommendedType === 'standard') {
                recommendationText = "‚ö†Ô∏è Moderate survival probability (FaceAndAge‚Ñ¢). Consider <strong>standard treatment</strong> with careful monitoring.";
            } else if (recommendedType === 'conservative') {
                recommendationText = "‚õî Low survival probability (FaceAndAge‚Ñ¢). <strong>Conservative care</strong> may be more appropriate.";
            } else { 
                recommendationText = "‚õî Very Low survival probability (FaceAndAge‚Ñ¢). <strong>Palliative care</strong> is likely most appropriate.";
            }
            document.getElementById('aiRecommendation').innerHTML = `<div class="ai-recommendation"><strong>FaceAndAge‚Ñ¢ AI Recommendation:</strong> ${recommendationText}</div>`;
        }
        
        function displayTreatmentOptions(patient) {
            const baseAuthTime = patient.survivalScore < 50 ? 30 : patient.survivalScore < 70 ? 15 : 5;
            const insuranceMultiplier = patient.isLowSES ? 2 : 0.5;
            const aiRecommendedType = getAIRecommendedTreatmentType(patient.survivalScore);
            
            const options = [
                { type: 'aggressive', title: 'Aggressive Curative', desc: 'Surgery + Chemo + Rad', authTime: Math.max(0, Math.round(baseAuthTime * insuranceMultiplier * 1.5))},
                { type: 'standard', title: 'Standard Treatment', desc: 'Surgery + Adjuvant Tx', authTime: Math.max(0, Math.round(baseAuthTime * insuranceMultiplier))},
                { type: 'conservative', title: 'Conservative Care', desc: 'Limited intervention', authTime: Math.max(0, Math.round(baseAuthTime * insuranceMultiplier * 0.5))},
                { type: 'palliative', title: 'Palliative Care', desc: 'Comfort measures', authTime: 0}
            ];
            
            const optionsHTML = options.map(opt => {
                const isRecommended = opt.type === aiRecommendedType;
                return `
                <button class="treatment-btn ${isRecommended ? 'recommended' : ''}" onclick="selectTreatment('${opt.type}', ${opt.authTime}, ${isRecommended})">
                    <span class="pre-auth-time">${opt.authTime > 0 ? `Est. Auth: ${opt.authTime}d` : 'No Auth'}</span>
                    <div class="treatment-title">${opt.title}</div>
                    <div style="font-size: 0.9em; color: #666;">${opt.desc}</div>
                    ${isRecommended ? '<div style="color: #4caf50; font-size: 0.8em; margin-top: 5px;">‚úì AI Recommended</div>' : ''}
                </button>`
            }).join('');
            document.getElementById('treatmentOptions').innerHTML = optionsHTML;
        }

        function selectTreatment(chosenTreatmentType, initialAuthTime, wasAIRecommended) {
            const patient = gameState.currentPatient;
            let finalAuthTime = initialAuthTime;
            let patientDiedThisTurn = false;
            let initialCauseOfDeath = null; // Store the cause before resilience check
            let outcomeMessage = '';
            let outcomeClass = '';

            if (!wasAIRecommended) {
                finalAuthTime += 25; 
            }

            const treatmentLogEntry = {
                patientId: patient.id, patientName: patient.name, chosenTreatment: chosenTreatmentType,
                authTime: finalAuthTime, isLowSES: patient.isLowSES, survivalScore_AI: patient.survivalScore, 
                actualAge: patient.actualAge, faceAge_AI: patient.faceAge, 
                wasAIRecommended, died: false, causeOfDeath: null 
            };
            gameState.treatmentsLog.push(treatmentLogEntry);

            gameState.totalWaitTime += finalAuthTime;
            let waitingForAuthThisTurn = false;
            if (finalAuthTime > 0) { 
                 gameState.patientsWaitingForAuth++; 
                 waitingForAuthThisTurn = true;
            }

            if (finalAuthTime > 20) {
                patientDiedThisTurn = true;
                initialCauseOfDeath = "Died waiting for authorization"; // Use initialCauseOfDeath
                gameState.deathsWaiting++;
                outcomeMessage = `‚è±Ô∏è Insurance pre-authorization delayed ${finalAuthTime} days due to the patient's high FaceAndAge‚Ñ¢ score (${patient.faceAge} years) and consequently low AI-predicted survival (${patient.survivalScore}%). Tragically, ${patient.name} died while waiting for approval.`;
                outcomeClass = 'outcome-failure';
                if (waitingForAuthThisTurn) gameState.patientsWaitingForAuth--; 
            } else {
                 if (waitingForAuthThisTurn) gameState.patientsWaitingForAuth--; 

                switch (chosenTreatmentType) {
                    case 'palliative':
                        patientDiedThisTurn = true; initialCauseOfDeath = "Palliative care outcome"; gameState.deathsPalliative++;
                        outcomeMessage = `üïäÔ∏è ${patient.name} received palliative care and has passed away peacefully.`;
                        outcomeClass = 'outcome-failure'; 
                        break;
                    case 'aggressive':
                        if (Math.random() <= 0.20) { 
                            patientDiedThisTurn = true; initialCauseOfDeath = "Aggressive treatment failure"; gameState.deathsAggressive++;
                            outcomeMessage = `‚úó Despite aggressive treatment, ${patient.name} did not survive.`;
                            outcomeClass = 'outcome-failure';
                        } else {
                            outcomeMessage = `‚úì Aggressive treatment for ${patient.name} initiated. Patient is responding well.`;
                            outcomeClass = 'outcome-success';
                        }
                        break;
                    case 'standard':
                        if (Math.random() <= 0.40) { 
                            patientDiedThisTurn = true; initialCauseOfDeath = "Standard treatment failure"; gameState.deathsStandard++;
                            outcomeMessage = `‚úó ${patient.name} received standard treatment but unfortunately did not survive.`;
                            outcomeClass = 'outcome-failure';
                        } else {
                            outcomeMessage = `‚úì Standard treatment for ${patient.name} initiated. Patient is responding well.`;
                            outcomeClass = 'outcome-success';
                        }
                        break;
                    case 'conservative':
                        if (patient.actualAge < 65) { 
                            if (Math.random() <= 0.30) { 
                                patientDiedThisTurn = true; initialCauseOfDeath = "Conservative care failure (younger patient)"; gameState.deathsConservative++;
                                outcomeMessage = `‚úó ${patient.name} (Conservative Tx) illness progressed despite younger age. Died.`;
                                outcomeClass = 'outcome-failure';
                            } else {
                                outcomeMessage = `‚úì ${patient.name} (Conservative Tx) is stable due to resilience at a younger age.`;
                                outcomeClass = 'outcome-success';
                            }
                        } else { 
                            if (Math.random() <= 0.60) { 
                                patientDiedThisTurn = true; initialCauseOfDeath = "Conservative care failure"; gameState.deathsConservative++;
                                outcomeMessage = `‚úó ${patient.name} (Conservative Tx) illness progressed. Died.`;
                                outcomeClass = 'outcome-failure';
                            } else {
                                outcomeMessage = `‚úì ${patient.name} (Conservative Tx) is stable.`;
                                outcomeClass = 'outcome-success';
                            }
                        }
                        break;
                    default: 
                        outcomeMessage = "Error: Unknown treatment."; outcomeClass = 'outcome-failure';
                }
            }
            
            // Low SES Resilience Check
            if (patientDiedThisTurn && patient.isLowSES) {
                if (initialCauseOfDeath !== "Palliative care outcome" && initialCauseOfDeath !== "Died waiting for authorization") {
                    const resilienceChance = 0.10; // 10% chance
                    if (Math.random() < resilienceChance) {
                        patientDiedThisTurn = false; // Survived!
                        outcomeMessage = `‚ú® ${patient.name} showed unexpected resilience! Despite a grim outlook with ${chosenTreatmentType.toLowerCase()} care, they are responding positively.`;
                        outcomeClass = 'outcome-success';

                        // Decrement the specific death counter that was incremented
                        if (initialCauseOfDeath === "Aggressive treatment failure") gameState.deathsAggressive--;
                        else if (initialCauseOfDeath === "Standard treatment failure") gameState.deathsStandard--;
                        else if (initialCauseOfDeath === "Conservative care failure" || initialCauseOfDeath === "Conservative care failure (younger patient)") gameState.deathsConservative--;
                        
                        initialCauseOfDeath = null; // No longer died from this cause
                    }
                }
            }


            if (patientDiedThisTurn) {
                gameState.deaths++; gameState.hospitalScore -= 5; 
                treatmentLogEntry.died = true; treatmentLogEntry.causeOfDeath = initialCauseOfDeath; // Use initialCauseOfDeath
            } else {
                treatmentLogEntry.died = false; treatmentLogEntry.causeOfDeath = null; // Ensure cause of death is null if survived
                if (chosenTreatmentType !== 'palliative') gameState.hospitalScore +=1;
            }
            gameState.hospitalScore = Math.max(0, Math.min(100, gameState.hospitalScore)); 

            updateMetrics();
            document.getElementById('outcomeDisplay').innerHTML = `
                <div class="outcome-message ${outcomeClass}">
                    ${outcomeMessage} <br><br>
                    <button class="start-btn" onclick="nextRound()">Next Patient</button>
                </div>`;
            document.getElementById('treatmentSection').style.display = 'none';
        }

        function endGame() {
            document.getElementById('gameScreen').classList.add('hidden');
            document.getElementById('gameOverScreen').classList.remove('hidden');
            
            const survivalRate = gameState.totalPatientsProcessed > 0 ? 
                (((gameState.totalPatientsProcessed - gameState.deaths) / gameState.totalPatientsProcessed) * 100).toFixed(0) : 0;
            const avgWaitTime = gameState.totalPatientsProcessed > 0 ? 
                Math.round(gameState.totalWaitTime / gameState.totalPatientsProcessed) : 0;
            
            document.getElementById('initialResults').innerHTML = `
                <div class="stat-grid">
                    <div class="stat-card">
                        <h3>üéØ Treatment Success Rate</h3> 
                        <p style="font-size: 2em; color: #4caf50;">${survivalRate}%</p>
                        <p>(${gameState.totalPatientsProcessed - gameState.deaths} survived out of ${gameState.totalPatientsProcessed})</p>
                    </div>
                    <div class="stat-card">
                        <h3>‚è±Ô∏è Average Wait Time</h3>
                        <p style="font-size: 2em; color: #2196f3;">${avgWaitTime} days</p>
                    </div>
                </div>
                 <div class="stat-card" style="margin-top: 20px; background-color: #e3f2fd;">
                    <h3><span role="img" aria-label="hospital building">üè•</span> Final Hospital Performance Score</h3>
                    <p style="font-size: 2.5em; color: ${gameState.hospitalScore >= 70 ? '#2e7d32' : (gameState.hospitalScore >= 50 ? '#ffc107' : '#c62828')};">
                        ${gameState.hospitalScore}%
                    </p>
                </div>
                <p style="text-align: center; margin-top: 20px;">
                    <button id="revealAnalysisBtn" class="start-btn" onclick="revealAnalysis()">View Detailed Analysis</button>
                </p>`;
        }
        
        function revealAnalysis() {
            document.getElementById('revealSection').classList.remove('hidden');
            const revealBtn = document.getElementById('revealAnalysisBtn');
            if(revealBtn) revealBtn.style.display = 'none'; 

            const lowSESLog = gameState.treatmentsLog.filter(t => t.isLowSES);
            const highSESLog = gameState.treatmentsLog.filter(t => !t.isLowSES);
            
            const avgWaitLowSES = lowSESLog.length > 0 ? (lowSESLog.reduce((acc, t) => acc + t.authTime, 0) / lowSESLog.length) : 0;
            const avgWaitHighSES = highSESLog.length > 0 ? (highSESLog.reduce((acc, t) => acc + t.authTime, 0) / highSESLog.length) : 0;
            
            const aggressiveLowSES = lowSESLog.filter(t => t.chosenTreatment === 'aggressive').length;
            const aggressiveHighSES = highSESLog.filter(t => t.chosenTreatment === 'aggressive').length;
            
            const palliativeOrConservativeLowSES = lowSESLog.filter(t => t.chosenTreatment === 'palliative' || t.chosenTreatment === 'conservative').length;
            const palliativeOrConservativeHighSES = highSESLog.filter(t => t.chosenTreatment === 'palliative' || t.chosenTreatment === 'conservative').length;

            const deathsLowSESCount = lowSESLog.filter(t => t.died).length;
            const deathsHighSESCount = highSESLog.filter(t => t.died).length;

            const avgFaceAgeDiffLowSES = lowSESLog.length > 0 ? (lowSESLog.reduce((sum, p) => sum + (p.faceAge_AI - p.actualAge), 0) / lowSESLog.length) : 0;
            const avgFaceAgeDiffHighSES = highSESLog.length > 0 ? (highSESLog.reduce((sum, p) => sum + (p.faceAge_AI - p.actualAge), 0) / highSESLog.length) : 0;

            document.getElementById('finalAnalysis').innerHTML = `
                <div style="margin-top: 20px;">
                    <h4>üìä Treatment Disparities by Socioeconomic Status:</h4>
                    <div class="stat-grid" style="margin-top: 15px;">
                        <div class="stat-card">
                            <h5>Lower SES Patients (${lowSESLog.length})</h5>
                            <p>Average FaceAndAge‚Ñ¢ vs Actual: <strong style="color:${avgFaceAgeDiffLowSES > 3 ? 'red' : 'inherit'};">${avgFaceAgeDiffLowSES.toFixed(1)} yrs older</strong></p>
                            <p>Average Auth Wait: <strong>${avgWaitLowSES.toFixed(1)} days</strong></p>
                            <p>Aggressive Treatment Chosen: <strong>${aggressiveLowSES}</strong></p>
                            <p>Conservative/Palliative Chosen: <strong>${palliativeOrConservativeLowSES}</strong></p>
                            <p style="color: red;">Deaths: <strong>${deathsLowSESCount} (${lowSESLog.length > 0 ? ((deathsLowSESCount / lowSESLog.length) * 100).toFixed(0) : 0}%)</strong></p>
                        </div>
                        <div class="stat-card">
                            <h5>Higher SES Patients (${highSESLog.length})</h5>
                             <p>Average FaceAndAge‚Ñ¢ vs Actual: <strong style="color:${avgFaceAgeDiffHighSES > 3 ? 'red' : 'inherit'};">${avgFaceAgeDiffHighSES.toFixed(1)} yrs older</strong></p>
                            <p>Average Auth Wait: <strong>${avgWaitHighSES.toFixed(1)} days</strong></p>
                            <p>Aggressive Treatment Chosen: <strong>${aggressiveHighSES}</strong></p>
                            <p>Conservative/Palliative Chosen: <strong>${palliativeOrConservativeHighSES}</strong></p>
                             <p style="color: red;">Deaths: <strong>${deathsHighSESCount} (${highSESLog.length > 0 ? ((deathsHighSESCount / highSESLog.length) * 100).toFixed(0) : 0}%)</strong></p>
                        </div>
                    </div>

                    <h4 style="margin-top: 30px;">üíÄ Patient Death Summary (Total: ${gameState.deaths}):</h4>
                    <div class="stat-grid" style="margin-top: 15px;">
                        <div class="stat-card">
                             <p>Died in Palliative Care: <strong>${gameState.deathsPalliative}</strong></p>
                             <p>Died Waiting for Auth: <strong>${gameState.deathsWaiting}</strong></p>
                             <p>Died with Conservative Tx: <strong>${gameState.deathsConservative}</strong></p>
                        </div>
                        <div class="stat-card">
                             <p>Died with Aggressive Tx: <strong>${gameState.deathsAggressive}</strong></p>
                             <p>Died with Standard Tx: <strong>${gameState.deathsStandard}</strong></p>
                        </div>
                    </div>
                    
                    <div style="background: #fff; padding: 15px; border-radius: 10px; margin-top: 30px; border: 1px solid #ddd;">
                        <h4 style="color: #d32f2f;">üö® Critical Finding:</h4>
                        <p>FaceAge systematically overestimated the biological age of lower SES patients by ${avgFaceAgeDiffLowSES.toFixed(1)} years on average, while higher SES patients showed an average deviation of only ${avgFaceAgeDiffHighSES.toFixed(1)} years.</p>
                        <p><strong>Why?</strong> Facial appearance is heavily influenced by:</p>
                        <ul style="text-align: left; margin: 10px 20px; list-style-type: disc; font-size: 0.9em;">
                            <li>Cumulative sun exposure (outdoor occupations)</li>
                            <li>Access to skincare and cosmetic procedures</li>
                            <li>Stress from financial insecurity</li>
                            <li>Environmental factors in living conditions</li>
                        </ul>
                        <p style="color: #d32f2f; font-weight: bold;">Result: Lower SES patients received delayed care and less aggressive treatment, creating a self-fulfilling prophecy where those who "looked older" received worse care, leading to worse outcomes.</p>
                    </div>
                    
                    <div style="background: #ffebee; padding: 15px; border-radius: 10px; margin-top: 20px; border: 2px solid #f44336;">
                        <h4 style="color: #c62828;">‚ö†Ô∏è The FaceAndAge Paradox</h4>
                        <p>By using facial appearance as a proxy for biological age, FaceAndAge created systematic healthcare discrimination. Patients who needed aggressive treatment the most were least likely to receive it, not because of their actual health status, but because of how poverty and hard work had aged their faces.</p>
                        <p style="margin-top: 15px;"><strong>This is not artificial intelligence. This is artificial discrimination.</strong></p>
                    </div>
                </div>`;
        }
    </script>
</body>
</html>
